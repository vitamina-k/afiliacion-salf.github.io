<!DOCTYPE html>
<button class="btn" id="fitEsp">üá™üá∏ Ver Espa√±a</button>
</div>
<div id="map"></div>
<div class="bottom-right">
<button class="btn" id="exportPng">üñºÔ∏è Descargar PNG</button>
</div>
</main>
</div>


<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" crossorigin="anonymous"></script>
<script>
// ====== Estado ======
let rows = []; // { ciudad, provincia, personas }
let markers = new Map(); // key => marker
const $ = (s)=> document.querySelector(s);
const sleep = (ms)=> new Promise(r=>setTimeout(r,ms));


// ====== Mapa ======
const map = L.map('map');
map.setView([40.25,-3.7], 5.5);
const base = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {maxZoom: 18, attribution: '¬© OpenStreetMap & CARTO', crossOrigin: true}).addTo(map);
function markerSize(n){ return Math.min(80, Math.max(18, 16 + Math.sqrt(n)*6)); }
function makeIcon(n){ const s=markerSize(n); return L.divIcon({ className:'', html:`<div style="background:#2957ff;color:#fff;border-radius:999px;border:2px solid rgba(255,255,255,.85);width:${s}px;height:${s}px;display:flex;align-items:center;justify-content:center;font-weight:800;box-shadow:0 10px 20px rgba(0,0,0,.35),0 0 0 3px rgba(255,255,255,.2) inset">${n}</div>`, iconSize:[s,s], iconAnchor:[s/2,s/2] }); }


// ====== Geocache (localStorage) ======
async function geocode(ciudad, provincia){
const key = `geo__${provincia}__${ciudad}`;
const cached = localStorage.getItem(key);
if(cached){ try{ return JSON.parse(cached); }catch(_){} }
const url = new URL('https://nominatim.openstreetmap.org/search');
url.searchParams.set('format','jsonv2');
url.searchParams.set('q', `${ciudad}, ${provincia}, Espa√±a`);
url.searchParams.set('limit','1');
const res = await fetch(url, { headers: { 'Accept': 'application/json' }});
const data = await res.json();
if(data?.length){ const out = { lat: +data[0].lat, lon: +data[0].lon }; localStorage.setItem(key, JSON.stringify(out)); await sleep(300); return out; }
return null;
}


function upsertMarker(r, lat, lon){
const key = `${r.provincia}__${r.ciudad}`;
let m = markers.get(key);
if(!m){ m = L.marker([lat,lon], { icon: makeIcon(r.personas) }).addTo(map); markers.set(key,m); }
else { m.setLatLng([lat,lon]); m.setIcon(makeIcon(r.personas)); }
m.bindPopup(`<div style="min-width:220px"><div style="font-weight:800">${r.ciudad}</div><div class="sub">${r.provincia}</div><div class="chip">Personas: <b>${r.personas}</b></div></div>`);
}


async function renderMarkers(){
// Limpiar los que ya no est√°n
const active = new Set(rows.map(r=> `${r.provincia}__${r.ciudad}`));
for(const [k,m] of markers){ if(!active.has(k)){ m.remove(); markers.delete(k); } }
// Pintar actuales
for(const r of rows){
try{
const g = await geocode(r.ciudad, r.provincia);
if(g) upsertMarker(r, g.lat, g.lon);
}catch(e){/* noop */}
}
}


function renderTable(){
const q = ($('#buscar').value||'').toLowerCase();
const prov = $('#filtroProv').value || 'Todas';
const tbody = $('#tbl tbody'); tbody.innerHTML='';
let total = 0;
const items = rows.filter(r=> (prov==='Todas' || r.provincia===prov) && (!q || (r.ciudad+" "+r.provincia).toLowerCase().includes(q)))
.sort((a,b)=> (b.personas-a.personas) || a.provincia.localeCompare(b.provincia) || a.ciudad.localeCompare(b.ciudad));
for(const r of items){
total += Number(r.personas)||0;
const tr = document.createElement('tr');
tr.innerHTML = `<td>${r.ciudad}</td><td>${r.provincia}</td><td style="text-align:right">${r.personas}</td>`;
tr.ondblclick = async ()=>{
const g = await geocode(r.ciudad, r.provincia); if(g) map.setView([g.lat,g.lon], 11);
};
tbody.appendChild(tr);
}
$('#sumSpan').textContent = `Total: ${total}`;
}


function buildProvFilter(){
const sel = $('#filtroProv');
const set = new Set(rows.map(r=> r.provincia));
const cur = sel.value;
sel.innerHTML = `<option value="Todas">Todas</option>` + Array.from(set).sort().map(p=> `<option value="${p}">${p}</option>`).join('');
sel.value = cur||'Todas';
}


async function loadData(){
const res = await fetch('data/agregado.json', { cache: 'no-store' });
const data = await res.json();
rows = Array.isArray(data)? data : (data.rows||[]);
buildProvFilter();
renderTable();
renderMarkers();
}


$('#fitEsp').onclick = ()=> map.setView([40.25,-3.7], 5.5);
$('#reloadBtn').onclick = loadData;
$('#buscar').oninput = renderTable;
$('#filtroProv').onchange = ()=>{ renderTable(); renderMarkers(); };
$('#exportPng').onclick = async()=>{
await sleep(200);
const canvas = await html2canvas(document.getElementById('map'), { useCORS:true, backgroundColor:'#ffffff', scale:2 });
const a = document.createElement('a'); a.download = 'afiliados_es.png'; a.href = canvas.toDataURL('image/png'); a.click();
};


// Inicio
loadData();
</script>
</body>
</html>
